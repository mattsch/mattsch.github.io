<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.9.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Xen and vlans - Excentral</title>




<meta name="description" content="During a big lab move at work a few months ago, we decided that our utility virt server needed VLAN support.  The dhcp vm needed interfaces on three different networks and it seemed rather silly to add extra physical interface for the minimal traffic generated.">




<meta name="author" content="Matthew Schick">

<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Excentral">
<meta property="og:title" content="Xen and vlans">


  <link rel="canonical" href="https://www.excentral.org/archives/2008/07/07/xen-and-vlans">
  <meta property="og:url" content="https://www.excentral.org/archives/2008/07/07/xen-and-vlans">



  <meta property="og:description" content="During a big lab move at work a few months ago, we decided that our utility virt server needed VLAN support.  The dhcp vm needed interfaces on three different networks and it seemed rather silly to add extra physical interface for the minimal traffic generated.">















  <meta name="twitter:site" content="@MattSchick">
  <meta name="twitter:title" content="Xen and vlans">
  <meta name="twitter:description" content="During a big lab move at work a few months ago, we decided that our utility virt server needed VLAN support.  The dhcp vm needed interfaces on three different networks and it seemed rather silly to add extra physical interface for the minimal traffic generated.">
  <meta name="twitter:url" content="https://www.excentral.org/archives/2008/07/07/xen-and-vlans">

  
    <meta name="twitter:card" content="summary">
    
  

  
    <meta name="twitter:creator" content="@Matthew Schick">
  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2008-07-07T09:11:41-04:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Matthew Schick",
      "url" : "https://www.excentral.org",
      "sameAs" : ["https://twitter.com/MattSchick"]
    }
  </script>







<!-- end SEO -->


<link href="https://www.excentral.org/feed.xml" type="application/atom+xml" rel="alternate" title="Excentral Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="https://www.excentral.org/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="https://www.excentral.org/">Excentral</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="https://www.excentral.org/categories/" >Categories</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="https://www.excentral.org/tags/" >Tags</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Matthew Schick</h3>
    
    
      <p class="author__bio" itemprop="description">
        Dad, geek, ginger.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">North Carolina</span>
        </li>
      

      

      

      
        <li>
          <a href="https://keybase.io/mattschick" itemprop="sameAs">
            <i class="fas fa-fw fa-key" aria-hidden="true"></i> Keybase
          </a>
        </li>
      

      
        <li>
          <a href="https://twitter.com/MattSchick" itemprop="sameAs">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/mattsch" itemprop="sameAs">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      
        <li>
          <a href="https://gitlab.com/mattsch" itemprop="sameAs">
            <i class="fab fa-fw fa-gitlab" aria-hidden="true"></i> GitLab
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Xen and vlans">
    <meta itemprop="description" content="During a big lab move at work a few months ago, we decided that our utility virt server needed VLAN support.  The dhcp vm needed interfaces on three different networks and it seemed rather silly to add extra physical interface for the minimal traffic generated.">
    <meta itemprop="datePublished" content="July 07, 2008">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Xen and vlans
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>During a big lab move at <a href="http://www.redhat.com">work</a> a few months ago, we decided that our utility virt server needed VLAN support.  The dhcp vm needed interfaces on three different networks and it seemed rather silly to add extra physical interface for the minimal traffic generated.</p>

<p>The first issue we encountered was the rather interesting bridging script installed by default.  It does wonders for being able to bridge the primary interface and can be used to bridge multiple interface, but it fails entirely for VLAN interfaces.  Best bet is just to disable any network scripts in /etc/xen/xend-config.sxp and let the os handle it.  We’re using RHEL5, so we created the VLAN interface along with the bridge using the normal configs in /etc/sysconfig/network-scripts.  Our naming scheme for the devices was ${DEVICE_TYPE}{$VLAN_NUMBER}.conf.</p>

<p>Example vlan123.conf:</p>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DEVICE</span>=<span class="n">vlan123</span>
<span class="n">VLAN</span>=<span class="n">yes</span>
<span class="n">VLAN_NAME_TYPE</span>=<span class="n">VLAN_PLUS_VID_NO_PAD</span>
<span class="n">PHYSDEV</span>=<span class="n">eth1</span>
<span class="n">BOOTPROTO</span>=<span class="n">static</span>
<span class="n">ONBOOT</span>=<span class="n">yes</span>
<span class="n">BRIDGE</span>=<span class="n">xenbr123</span>
</code></pre></div></div>

<p>As you can see, eth1 is the physical interface connected to the switch port tagged with the vlans.  We added the ‘VLAN_PLUS_VID_NO_PAD’ param to use the vlan${NUMBER} scheme.  We aren’t bringing the interface up with an ip as it’s gonna be part of a bridge.</p>

<p>xenbr123.conf:</p>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DEVICE</span>=<span class="n">xenbr123</span>
<span class="n">TYPE</span>=<span class="n">Bridge</span>
<span class="n">BOOTPROTO</span>=<span class="n">static</span>
<span class="n">ONBOOT</span>=<span class="n">yes</span>
</code></pre></div></div>

<p>This brings up our bridge without an ip address.  The dom0 doesn’t need an ip on this VLAN, so no point in enabling it.  To use the bridge in your domu’s, just specify the interface in the config file (or at creation time).</p>

<p>Example domu def file with multiple interfaces:</p>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">name</span> = <span class="s2">"example"</span>
<span class="n">uuid</span> = <span class="s2">"62e4f71f-a46c-25f7-e947-f161aaad6f00"</span>
<span class="n">maxmem</span> = <span class="m">512</span>
<span class="n">memory</span> = <span class="m">512</span>
<span class="n">vcpus</span> = <span class="m">1</span>
<span class="n">bootloader</span> = <span class="s2">"/usr/bin/pygrub"</span>
<span class="n">on_poweroff</span> = <span class="s2">"destroy"</span>
<span class="n">on_reboot</span> = <span class="s2">"restart"</span>
<span class="n">on_crash</span> = <span class="s2">"restart"</span>
<span class="n">vfb</span> = [  ]
<span class="n">disk</span> = [ <span class="s2">"phy:/dev/vm/example,xvda,w"</span> ]
<span class="n">vif</span> = [ <span class="s2">"mac=00:16:3e:4b:a5:46,bridge=xenbr123"</span>, <span class="s2">"mac=00:16:3e:4b:a5:4a,bridge=xenbr456"</span>, <span class="n">mac</span>=<span class="m">00</span>:<span class="m">16</span>:<span class="m">3</span><span class="n">e</span>:<span class="m">4</span><span class="n">b</span>:<span class="n">a5</span>:<span class="m">47</span>,<span class="n">bridge</span>=<span class="n">xenbr789</span><span class="err">"</span>]
</code></pre></div></div>

<p>The above was pretty straightforward, but after putting it in place we ran into a very odd issue.  The vm’s couldn’t actually communicate via the vlan’d interfaces.  After a bit of tcpdumping we discovered the default firewall was allowing outbound traffic on the bridge, but incoming was getting rejected.  Easy fix was to add the following lines to /etc/sysconfig/iptables:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-<span class="n">A</span> <span class="n">RH</span>-<span class="n">Firewall</span>-<span class="m">1</span>-<span class="n">INPUT</span> -<span class="n">i</span> <span class="n">xenbr</span>+ -<span class="n">j</span> <span class="n">ACCEPT</span> 
-<span class="n">A</span> <span class="n">RH</span>-<span class="n">Firewall</span>-<span class="m">1</span>-<span class="n">INPUT</span> -<span class="n">o</span> <span class="n">xenbr</span>+ -<span class="n">j</span> <span class="n">ACCEPT</span> 
</code></pre></div></div>

<p>Note that this allows <strong>all</strong> traffic to pass on <strong>all</strong> xenbr devices.  Since the dom0 doesn’t have an ip bound it’s not an issue in our configuration since the only traffic on the bridges are for the domu’s.  If you do use the devices in your dom0, you’ll need to adjust the firewall accordingly or you’ll end up with a gaping hole in your security scheme.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://www.excentral.org/categories/work" class="page__taxonomy-item" rel="tag">Work</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2008-07-07T09:11:41-04:00">July 07, 2008</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=MattSchick&text=Xen+and+vlans%20https%3A%2F%2Fwww.excentral.org%2Farchives%2F2008%2F07%2F07%2Fxen-and-vlans" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.excentral.org%2Farchives%2F2008%2F07%2F07%2Fxen-and-vlans" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=https%3A%2F%2Fwww.excentral.org%2Farchives%2F2008%2F07%2F07%2Fxen-and-vlans" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.excentral.org%2Farchives%2F2008%2F07%2F07%2Fxen-and-vlans" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="https://www.excentral.org/archives/2008/07/06/openid-two-factor-authentication" class="pagination--pager" title="Openid two-factor authentication
">Previous</a>
    
    
      <a href="https://www.excentral.org/archives/2008/08/24/on-vacation-2" class="pagination--pager" title="On Vacation
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.excentral.org/archives/2014/10/21/rss-update" rel="permalink">RSS Update
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">I’ve been using FeedBurner for so long I’d forgotten about it, not unlike Google who seems to be letting it die a slow death.  I’ve disabled my redirects and...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.excentral.org/archives/2014/04/16/ansible-variables" rel="permalink">Ansible variables
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Been doing some abstraction refactoring for work and ran into a situation where
I had a task that used the command module in a loop and I needed to be able t...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.excentral.org/archives/2014/02/19/mendel90-marlin" rel="permalink">Mendel90 Marlin
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">For those looking to run a recent version of Marlin on a Mendel90 from nophead, I track upstream in my own branches on GitHub.  There are two versions; one f...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.excentral.org/archives/2014/02/07/3d-printing-tips" rel="permalink">3D Printing Tips
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Just a few things I’ve learned over the past few weeks:

	Travel rate matters - On both my Prusa I3 and Mendel90 I had the non-print travel rate ratched up t...</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
  <input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  <div id="results" class="results"></div>
</div>
      </div>
    

    <div class="page__footer">
      <footer>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Jekyll footer -->
<div align="center" style="margin: 1em 0;">
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5102983321402120"
     data-ad-slot="8378251347"
     data-ad-format="auto"></ins>
</div>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/MattSchick"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="https://github.com/mattsch"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
      <li><a href="https://gitlab.com/mattsch"><i class="fab fa-fw fa-gitlab" aria-hidden="true"></i> Gitlab</a></li>
    
    
    <li><a href="https://www.excentral.org/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 excentral. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="https://www.excentral.org/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.0.2/js/all.js"></script>



  
  
  <script defer src="https://www.excentral.org/assets/js/lunr/lunr.min.js"></script>
  <script defer src="https://www.excentral.org/assets/js/lunr/lunr-store.js"></script>
  <script defer src="https://www.excentral.org/assets/js/lunr/lunr-en.js"></script>





    
  <script>
    var disqus_config = function () {
      this.page.url = "https://www.excentral.org/archives/2008/07/07/xen-and-vlans";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/archives/2008/07/07/xen-and-vlans"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://excentral.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>